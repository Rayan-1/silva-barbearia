<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Silva do Corte</title>
    <style>
        /* ESTILOS GERAIS */
        :root {
            --primary: #facc15;
            --primary-dark: #eab308;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --text: #ffffff;
            --text-light: #cbd5e1;
            --text-lighter: #94a3b8;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark);
            color: var(--text);
            line-height: 1.5;
        }

        /* MODAL DE LOGIN */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-box {
            background-color: var(--dark-light);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            border: 2px solid var(--primary);
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .login-box h2 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }
        
        .login-box input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: none;
            font-size: 1rem;
            background-color: var(--text);
            color: var(--dark);
        }
        
        .login-box button {
            background-color: var(--primary);
            color: var(--dark);
            border: none;
            padding: 0.8rem;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-top: 0.5rem;
            transition: background-color 0.3s;
        }
        
        .login-box button:hover {
            background-color: var(--primary-dark);
        }
        
        .login-error {
            color: #ef4444;
            margin-top: 1rem;
            display: none;
            font-size: 0.9rem;
        }

        /* HEADER */
        header {
            background-color: var(--dark-light);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border-bottom: 1px solid #334155;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.2rem;
            color: var(--primary);
        }

        .top-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .top-right button {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .top-right .sair {
            border-color: var(--text);
            color: var(--text);
        }

        /* NAVEGAÇÃO */
        nav {
            background-color: var(--dark-light);
            padding: 0.5rem;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            border-bottom: 1px solid #334155;
        }

        nav::-webkit-scrollbar {
            display: none;
        }

        nav button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 0.9rem;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            white-space: nowrap;
        }

        nav button.active {
            background-color: var(--primary);
            color: black;
            border-radius: 5px;
            font-weight: bold;
        }

        /* CONTEÚDO PRINCIPAL */
        .main {
            padding: 1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        /* CARDS DE RESUMO */
        .cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background-color: var(--dark);
            border: 1px solid #334155;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .card span {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
        }

        .card:nth-child(1) span { color: #22c55e; }
        .card:nth-child(2) span { color: #3b82f6; }
        .card:nth-child(3) span { color: #a855f7; }
        .card:nth-child(4) span { color: var(--primary); }

        .card p {
            margin: 0;
            color: var(--text-light);
            font-size: 0.8rem;
        }

        /* MENSAGEM SEM DADOS */
        .no-data {
            margin: 2rem 0;
            text-align: center;
            color: var(--text-lighter);
            padding: 1rem;
            background-color: var(--dark);
            border-radius: 8px;
            border: 1px dashed #334155;
        }

        .no-data .icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* FORMULÁRIOS */
        .form-section {
            max-width: 100%;
            margin: 1.5rem 0;
        }

        .form-section label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .form-section input,
        .form-section select,
        .form-section textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: none;
            font-size: 1rem;
            background-color: var(--text);
            color: var(--dark);
        }

        .form-section textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-section button {
            background-color: var(--primary);
            color: black;
            font-weight: bold;
            padding: 0.8rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            margin-top: 0.5rem;
            transition: background-color 0.3s;
        }

        .form-section button:hover {
            background-color: var(--primary-dark);
        }

        /* BOTÕES DE AÇÃO */
        .delete-btn, .edit-btn {
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        .delete-btn {
            background-color: #ef4444;
            color: white;
        }

        .edit-btn {
            background-color: #3b82f6;
            color: white;
        }

        /* HORÁRIOS */
        .horarios-container {
            margin-top: 1.5rem;
        }

        .horarios-container h3 {
            margin-bottom: 1rem;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .horarios-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .horario-btn {
            background-color: #334155;
            color: var(--text-light);
            padding: 0.8rem 0;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.2s;
        }

        .horario-btn.selected {
            background-color: var(--primary);
            color: var(--dark);
        }

        .horario-btn.occupied {
            background-color: #ef4444;
            color: white;
            text-decoration: line-through;
            cursor: not-allowed;
        }

        .salvar-horarios-btn {
            background-color: var(--primary);
            color: black;
            font-weight: bold;
            padding: 0.8rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        /* LISTAS DE ITENS */
        .lista-itens {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
        }

        .lista-itens li {
            background-color: var(--dark);
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .lista-itens li img {
            width: 100%;
            height: auto;
            max-height: 150px;
            object-fit: cover;
            border-radius: 4px;
        }

        .lista-itens li h4 {
            margin: 0;
            color: var(--primary);
            font-size: 1rem;
        }

        .lista-itens li p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .lista-itens li .actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* AGENDAMENTOS */
        #listaAgendamentos {
            list-style: none;
            padding: 0;
            margin-top: 1.5rem;
        }

        #listaAgendamentos li {
            background-color: var(--dark);
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            position: relative;
        }

        #listaAgendamentos li .agendamento-info h4 {
            margin: 0 0 0.3rem 0;
            color: var(--primary);
            font-size: 1rem;
        }

        #listaAgendamentos li .agendamento-info p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .agendamento-status {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .status-pendente { background-color: var(--primary); color: var(--dark); }
        .status-confirmado { background-color: #22c55e; color: white; }
        .status-cancelado { background-color: #ef4444; color: white; }
        .status-concluido { background-color: #3b82f6; color: white; }
        .status-cortando { background-color: #a855f7; color: white; }

        #listaAgendamentos li .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        #listaAgendamentos li .actions button,
        #listaAgendamentos li .actions a {
            padding: 0.5rem 0.8rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-confirmar { background-color: #22c55e; color: white; }
        .btn-cancelar { background-color: #ef4444; color: white; }
        .btn-concluir { background-color: #3b82f6; color: white; }
        .btn-whatsapp { background-color: #25d366; color: white; }

        /* VERSÃO PARA TABLET */
        @media (min-width: 600px) {
            .cards {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .horarios-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .lista-itens li {
                flex-direction: row;
                align-items: center;
            }
            
            .lista-itens li img {
                width: 80px;
                height: 80px;
                max-height: none;
            }
        }

        /* VERSÃO PARA DESKTOP */
        @media (min-width: 900px) {
            body {
                padding: 0;
            }
            
            header {
                padding: 1rem 2rem;
                flex-direction: row;
                justify-content: space-between;
            }
            
            nav {
                padding: 0.5rem 2rem;
            }
            
            .main {
                padding: 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .form-section {
                max-width: 600px;
                margin: 2rem auto;
            }
            
            .horarios-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 0.8rem;
            }
            
            #listaAgendamentos li {
                flex-direction: row;
                align-items: center;
            }
            
            #listaAgendamentos li .agendamento-info {
                flex-grow: 1;
            }
            
            #listaAgendamentos li .actions {
                margin-top: 0;
            }
        }
    </style>
</head>
<body>

    <!-- Modal de Login -->
    <div id="loginModal" class="login-overlay">
        <div class="login-box">
            <h2>Acesso Administrativo</h2>
            <p>Por favor, insira a senha para continuar</p>
            <input type="password" id="adminPassword" placeholder="Senha de acesso">
            <button onclick="verificarSenha()">Acessar</button>
            <p id="loginError" class="login-error">Senha incorreta. Tente novamente.</p>
        </div>
    </div>

    <!-- Conteúdo do Painel (só aparece após login) -->
    <header>
        <div class="header-top">
            <h1>Painel Administrativo - Silva do Corte</h1>
            <div class="top-right">
                <button>Hoje (<span id="countHojeAgendamentos">0</span>)</button>
                <button class="sair" onclick="fazerLogout()">Sair</button>
            </div>
        </div>
    </header>

    <nav>
        <button class="active" onclick="mostrarAba('agendamentos', event)">Agendamentos</button>
        <button onclick="mostrarAba('horarios', event)">Horários</button>
        <button onclick="mostrarAba('servicos', event)">Serviços</button>
        <button onclick="mostrarAba('produtos', event)">Produtos</button>
        <button onclick="mostrarAba('datas', event)">Datas Bloqueadas</button>
        <button onclick="mostrarAba('lembretes', event)">Lembretes</button>
    </nav>

    <div class="main">
        <!-- Conteúdo das abas -->
        <div id="agendamentos" class="tab-content active">
            <h2>Agendamentos (<span id="agendamentosCount">0</span>)</h2>
            <div class="cards">
                <div class="card"><span>0</span><p>Próximos</p></div>
                <div class="card"><span>0</span><p>Hoje</p></div>
                <div class="card"><span>0</span><p>Total</p></div>
                <div class="card"><span>R$ 0,00</span><p>Faturamento</p></div>
            </div>
            <div class="no-data" id="noAgendamentosMessage">
                <p>📅 <strong>Nenhum agendamento encontrado</strong><br> Os agendamentos aparecerão aqui quando os clientes fizerem reservas.</p>
            </div>
            <ul id="listaAgendamentos"></ul>
        </div>

        <div id="horarios" class="tab-content">
            <div class="form-section">
                <label for="dataHorario">Data:</label>
                <input type="date" id="dataHorario" onchange="carregarHorariosData()">
            </div>

            <div class="horarios-container">
                <h3 id="horariosSelecionadosTitulo">Horários (0 selecionados)</h3>
                <div id="horariosGrid" class="horarios-grid"></div>
                <div class="no-data" id="noHorariosMessage" style="display: none;">
                    <p>Selecione uma data para gerenciar os horários disponíveis.</p>
                </div>
                <button class="salvar-horarios-btn" onclick="salvarHorariosManualmente()">
                    Salvar Seleção de Horários 
                </button>
            </div>
        </div>

        <div id="servicos" class="tab-content">
            <h2>Gerenciar Serviços</h2>
            <div class="form-section">
                <input type="hidden" id="servicoIndex" value="-1">

                <label for="nomeServico">Nome:</label>
                <input type="text" id="nomeServico" placeholder="Ex: Corte de Cabelo" required>
                
                <label for="fotoServico">Foto:</label>
                <input type="file" id="fotoServico" accept="image/*">
                <div id="previewContainerServico" style="margin-bottom: 1rem; display: none;">
                    <label>Foto Atual:</label><br>
                    <img id="fotoPreviewServico" src="" alt="Pré-visualização" style="max-width: 100px; max-height: 100px; border-radius: 4px; margin-top: 5px;">
                </div>
                
                <label for="descricaoServico">Descrição:</label>
                <textarea id="descricaoServico" rows="3" placeholder="Ex: Corte clássico masculino com acabamento na navalha."></textarea>
                
                <label for="valorServico">Valor (R$):</label>
                <input type="number" id="valorServico" placeholder="Ex: 50.00" step="0.01" required>
                
                <button id="btnAdicionarEditarServico" onclick="adicionarOuEditarServico()">Adicionar Serviço</button>
                <ul id="listaServicos" class="lista-itens"></ul>
            </div>
        </div>

        <div id="produtos" class="tab-content">
            <h2>Gerenciar Produtos</h2>
            <div class="form-section">
                <input type="hidden" id="produtoIndex" value="-1">

                <label for="nomeProduto">Nome:</label>
                <input type="text" id="nomeProduto" placeholder="Ex: Pomada Modeladora" required>
                
                <label for="fotoProduto">Foto:</label>
                <input type="file" id="fotoProduto" accept="image/*">
                <div id="previewContainerProduto" style="margin-bottom: 1rem; display: none;">
                    <label>Foto Atual:</label><br>
                    <img id="fotoPreviewProduto" src="" alt="Pré-visualização" style="max-width: 100px; max-height: 100px; border-radius: 4px; margin-top: 5px;">
                </div>
                
                <label for="descricaoProduto">Descrição:</label>
                <textarea id="descricaoProduto" rows="3" placeholder="Ex: Pomada para modelar cabelos com fixação forte."></textarea>
                
                <label for="valorProduto">Valor (R$):</label>
                <input type="number" id="valorProduto" placeholder="Ex: 25.00" step="0.01" required>
                
                <button id="btnAdicionarEditarProduto" onclick="adicionarOuEditarProduto()">Adicionar Produto</button>
                <ul id="listaProdutos" class="lista-itens"></ul>
            </div>
        </div>

        <div id="datas" class="tab-content">
            <h2>Bloquear Datas</h2>
            <div class="form-section">
                <label for="dataBloqueio">Data:</label>
                <input type="date" id="dataBloqueio">
                <button onclick="bloquearData()">Bloquear Data</button>
                <ul id="listaDatas"></ul>
            </div>
        </div>

        <div id="lembretes" class="tab-content">
            <h2>Lembretes</h2>
            <div class="form-section">
                <label for="lembrete">Novo Lembrete:</label>
                <textarea id="lembrete" rows="3" placeholder="Ex: Comprar material de barbear"></textarea>
                <button onclick="salvarLembrete()">Salvar</button>
                <ul id="listaLembretes"></ul>
            </div>
        </div>
    </div>

    <script>
        /* CONSTANTES */
        const ADMIN_PASSWORD = "silva2025";
        const LS_AUTH_KEY = "adminAuthToken";
        const LS_HORARIOS_KEY = 'horariosDisponiveis';
        const LS_SERVICOS_KEY = 'servicosSilvaDoCorte'; 
        const LS_PRODUTOS_KEY = 'produtosSilvaDoCorte';
        const LS_DATAS_BLOQUEADAS_KEY = 'datasBloqueadas';
        const LS_LEMBRETES_KEY = 'lembretes';
        const LS_AGENDAMENTOS_CLIENTES_KEY = 'agendamentosSilvaDoCorte';
        const WHATSAPP_NUMBER = '5588993143575';

        /* AUTENTICAÇÃO */
        function verificarSenha() {
            const senha = document.getElementById('adminPassword').value;
            const errorMsg = document.getElementById('loginError');
            
            if (senha === ADMIN_PASSWORD) {
                // Cria token de autenticação
                const authToken = btoa(`admin:${Date.now()}`);
                localStorage.setItem(LS_AUTH_KEY, authToken);
                
                // Esconde o modal e mostra o conteúdo
                document.getElementById('loginModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Inicializa a aplicação
                inicializarAplicacao();
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }
        
        function verificarAutenticacao() {
            const authToken = localStorage.getItem(LS_AUTH_KEY);
            if (!authToken) return false;
            
            try {
                const decoded = atob(authToken).split(':');
                return decoded[0] === 'admin';
            } catch (e) {
                return false;
            }
        }
        
        function fazerLogout() {
            localStorage.removeItem(LS_AUTH_KEY);
            window.location.href = 'index.html';
        }

        /* UTILITÁRIOS */
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        /* GERENCIAMENTO DE ABAS */
        function mostrarAba(id, event) {
            document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');

            // Carrega os dados específicos da aba
            if (id === 'horarios') {
                carregarHorariosData();
            } else if (id === 'servicos') {
                renderizarServicos();
            } else if (id === 'produtos') {
                renderizarProdutos();
            } else if (id === 'agendamentos') {
                renderizarAgendamentos();
                clearInterval(window.agendamentoStatusInterval);
                window.agendamentoStatusInterval = setInterval(verificarEAtualizarStatusAgendamentos, 60 * 1000);
            } else if (id === 'datas') {
                renderizarDatasBloqueadas();
            } else if (id === 'lembretes') {
                renderizarLembretes();
            }
        }

        /* AGENDAMENTOS */
        function renderizarAgendamentos() {
            const agendamentosClientes = JSON.parse(localStorage.getItem(LS_AGENDAMENTOS_CLIENTES_KEY)) || [];
            const noDataMessage = document.getElementById('noAgendamentosMessage');
            const cardsDiv = document.querySelector('.cards');
            const listaAgendamentos = document.getElementById('listaAgendamentos');
            listaAgendamentos.innerHTML = '';

            const cards = cardsDiv.querySelectorAll('.card span');
            let proximosCount = 0;
            let hojeCount = 0;
            let totalCount = agendamentosClientes.length;
            let faturamentoTotal = 0;
            const now = new Date();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (agendamentosClientes.length === 0) {
                noDataMessage.style.display = 'block';
                cardsDiv.style.display = 'grid'; 
                cards[0].textContent = '0';
                cards[1].textContent = '0';
                cards[2].textContent = '0';
                cards[3].textContent = 'R$ 0,00';
                document.getElementById('agendamentosCount').textContent = '0';
                document.getElementById('countHojeAgendamentos').textContent = '0';
                return;
            }

            noDataMessage.style.display = 'none';

            // Ordena agendamentos por data/hora
            agendamentosClientes.sort((a, b) => {
                const dateA = new Date(`${a.data}T${a.hora}`);
                const dateB = new Date(`${b.data}T${b.hora}`);
                return dateA - dateB;
            });

            // Processa cada agendamento
            agendamentosClientes.forEach((agendamento, index) => {
                const agendamentoDate = new Date(agendamento.data + 'T00:00:00');
                const agendamentoDateTime = new Date(`${agendamento.data}T${agendamento.hora}`);

                // Calcula faturamento
                if (agendamento.status === 'concluido') {
                    const valorDoServico = parseFloat(agendamento.valorServico || 0);
                    faturamentoTotal += valorDoServico;
                }

                // Conta agendamentos
                if (agendamentoDateTime.getTime() >= now.getTime() && agendamento.status !== 'cancelado') {
                    proximosCount++;
                }
                if (agendamentoDate.getTime() === today.getTime() && agendamento.status !== 'cancelado') {
                    hojeCount++;
                }

                // Cria elemento do agendamento
                const li = document.createElement('li');
                
                // Define classe de status
                let statusClass = 'status-' + (agendamento.status || 'pendente');
                
                // Formata valores
                const valorFormatado = parseFloat(agendamento.valorServico || 0).toFixed(2).replace('.', ',');
                const telefoneLimpo = agendamento.telefone ? agendamento.telefone.replace(/\D/g, '') : '';
                
                // Cria mensagem para WhatsApp
                const mensagemWhatsApp = encodeURIComponent(
                    `Olá ${agendamento.nomeCliente}, tudo bem? ` +
                    `Este é um lembrete do seu agendamento no Silva do Corte para um(a) ${agendamento.servico} ` +
                    `no dia ${agendamento.data} às ${agendamento.hora}. Estamos aguardando você!`
                );
                const linkWhatsApp = `https://wa.me/${telefoneLimpo}?text=${mensagemWhatsApp}`;

                // Monta HTML do agendamento
                li.innerHTML = `
                    <div class="agendamento-info">
                        <h4>${agendamento.servico} - ${agendamento.data} às ${agendamento.hora}</h4>
                        <p>Cliente: ${agendamento.nomeCliente} - ${agendamento.telefone || 'Telefone não informado'}</p>
                        <p>Valor: R$ ${valorFormatado}</p>
                    </div>
                    <span class="agendamento-status ${statusClass}">${(agendamento.status || 'pendente').charAt(0).toUpperCase() + (agendamento.status || 'pendente').slice(1)}</span>
                    <div class="actions">
                        ${agendamento.status !== 'cancelado' && agendamento.status !== 'concluido' ? `<button class="btn-cancelar" onclick="mudarStatusAgendamento(${index}, 'cancelado')">Cancelar</button>` : ''}
                        ${agendamento.status !== 'concluido' ? `<button class="btn-concluir" onclick="mudarStatusAgendamento(${index}, 'concluido')">Concluir</button>` : ''}
                        ${telefoneLimpo ? `<a href="${linkWhatsApp}" target="_blank" class="btn-whatsapp">WhatsApp</a>` : ''}
                        ${(agendamento.status === 'concluido' || agendamento.status === 'cancelado') ? `<button class="delete-btn" onclick="excluirAgendamento(${index})">Excluir</button>` : ''}
                    </div>
                `;
                listaAgendamentos.appendChild(li);
            });

            // Atualiza contadores
            cards[0].textContent = proximosCount;
            cards[1].textContent = hojeCount;
            cards[2].textContent = totalCount;
            cards[3].textContent = `R$ ${faturamentoTotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('agendamentosCount').textContent = totalCount;
            document.getElementById('countHojeAgendamentos').textContent = hojeCount;
        }

        function mudarStatusAgendamento(index, newStatus) {
            let agendamentosClientes = JSON.parse(localStorage.getItem(LS_AGENDAMENTOS_CLIENTES_KEY)) || [];
            if (index >= 0 && index < agendamentosClientes.length) {
                const agendamento = agendamentosClientes[index];
                const oldStatus = agendamento.status;
                
                if (oldStatus === newStatus) return;
                
                agendamento.status = newStatus;

                // Atualiza status no localStorage de horários se for cancelamento
                if (newStatus === 'cancelado') {
                    let horariosSalvos = JSON.parse(localStorage.getItem(LS_HORARIOS_KEY)) || {};
                    const dataAgendamento = agendamento.data;
                    
                    if (horariosSalvos[dataAgendamento]) {
                        const horarioIndex = horariosSalvos[dataAgendamento].findIndex(h => h.time === agendamento.hora);
                        if (horarioIndex !== -1) {
                            horariosSalvos[dataAgendamento][horarioIndex].status = 'available';
                            horariosSalvos[dataAgendamento][horarioIndex].bookedBy = undefined;
                            localStorage.setItem(LS_HORARIOS_KEY, JSON.stringify(horariosSalvos));
                        }
                    }
                }

                agendamentosClientes[index] = agendamento;
                localStorage.setItem(LS_AGENDAMENTOS_CLIENTES_KEY, JSON.stringify(agendamentosClientes));
                renderizarAgendamentos();
                
                if (newStatus === 'cancelado') {
                    carregarHorariosData(); // Atualiza a exibição dos horários
                }
            }
        }

        function excluirAgendamento(index) {
            if (confirm('Tem certeza que deseja EXCLUIR este agendamento? Esta ação é irreversível.')) {
                let agendamentosClientes = JSON.parse(localStorage.getItem(LS_AGENDAMENTOS_CLIENTES_KEY)) || [];
                const agendamento = agendamentosClientes[index];

                // Se não estiver cancelado/concluído, libera o horário
                if (agendamento.status !== 'cancelado' && agendamento.status !== 'concluido') {
                    let horariosSalvos = JSON.parse(localStorage.getItem(LS_HORARIOS_KEY)) || {};
                    const dataAgendamento = agendamento.data;
                    
                    if (horariosSalvos[dataAgendamento]) {
                        const horarioIndex = horariosSalvos[dataAgendamento].findIndex(h => h.time === agendamento.hora);
                        if (horarioIndex !== -1) {
                            horariosSalvos[dataAgendamento][horarioIndex].status = 'available';
                            horariosSalvos[dataAgendamento][horarioIndex].bookedBy = undefined;
                            localStorage.setItem(LS_HORARIOS_KEY, JSON.stringify(horariosSalvos));
                        }
                    }
                }

                agendamentosClientes.splice(index, 1);
                localStorage.setItem(LS_AGENDAMENTOS_CLIENTES_KEY, JSON.stringify(agendamentosClientes));
                renderizarAgendamentos();
                alert('Agendamento excluído com sucesso.');
            }
        }

        function verificarEAtualizarStatusAgendamentos() {
            let agendamentosClientes = JSON.parse(localStorage.getItem(LS_AGENDAMENTOS_CLIENTES_KEY)) || [];
            let changed = false;
            const now = new Date();
            const currentHourMinutes = now.getHours() * 60 + now.getMinutes();

            agendamentosClientes.forEach(agendamento => {
                const agendamentoDateTime = new Date(`${agendamento.data}T${agendamento.hora}`);
                const agendamentoHourMinutes = timeToMinutes(agendamento.hora);
                const duracaoServicoMinutos = 45;
                const agendamentoFimMinutos = agendamentoHourMinutes + duracaoServicoMinutos;

                // Verifica se está em andamento
                if ((agendamento.status === 'pendente' || agendamento.status === 'confirmado') && 
                    agendamentoDateTime.toDateString() === now.toDateString() && 
                    currentHourMinutes >= agendamentoHourMinutes && 
                    currentHourMinutes < agendamentoFimMinutos) {
                    
                    if (agendamento.status !== 'cortando') {
                        agendamento.status = 'cortando';
                        changed = true;
                    }
                }
                // Verifica se já deveria ter terminado
                else if ((agendamento.status === 'cortando' || agendamento.status === 'pendente' || agendamento.status === 'confirmado') &&
                         agendamentoDateTime.toDateString() === now.toDateString() && 
                         currentHourMinutes >= agendamentoFimMinutos) {
                    
                    if (agendamento.status !== 'concluido') {
                        agendamento.status = 'concluido';
                        changed = true;
                    }
                }
            });

            if (changed) {
                localStorage.setItem(LS_AGENDAMENTOS_CLIENTES_KEY, JSON.stringify(agendamentosClientes));
                renderizarAgendamentos();
            }
        }

        /* HORÁRIOS */
        function carregarHorariosData() {
            const data = document.getElementById('dataHorario').value;
            if (!data) {
                document.getElementById('noHorariosMessage').style.display = 'block';
                document.getElementById('horariosSelecionadosTitulo').style.display = 'none';
                return;
            }

            // Gera todos os horários das 8h às 23h com intervalo de 45min
            const todosHorarios = [];
            for (let hora = 8; hora <= 23; hora++) {
                for (let minuto = 0; minuto < 60; minuto += 45) {
                    if (hora === 23 && minuto > 0) break; // Não passa das 23h
                    const horario = `${String(hora).padStart(2, '0')}:${String(minuto).padStart(2, '0')}`;
                    todosHorarios.push(horario);
                }
            }

            // Verifica horários já salvos
            let horariosSalvos = JSON.parse(localStorage.getItem(LS_HORARIOS_KEY)) || {};
            let horariosDaData = horariosSalvos[data] || [];

            // Cria objetos de horário com status
            const horariosParaExibir = todosHorarios.map(time => {
                const horarioSalvo = horariosDaData.find(h => h.time === time);
                return {
                    time,
                    status: horarioSalvo ? horarioSalvo.status : 'available'
                };
            });

            // Renderiza os horários
            renderizarHorarios(horariosParaExibir);
            updateSelectedHorariosCount();
            document.getElementById('noHorariosMessage').style.display = 'none';
        }

        function renderizarHorarios(horarios) {
            const horariosGrid = document.getElementById('horariosGrid');
            horariosGrid.innerHTML = '';

            if (horarios.length === 0) return;

            // Verifica agendamentos existentes para marcar horários ocupados
            const agendamentos = JSON.parse(localStorage.getItem(LS_AGENDAMENTOS_CLIENTES_KEY)) || [];
            const dataSelecionada = document.getElementById('dataHorario').value;
            const agendamentosNaData = agendamentos.filter(a => 
                a.data === dataSelecionada && 
                a.status !== 'cancelado' && 
                a.status !== 'concluido'
            );

            horarios.forEach((h) => {
                const button = document.createElement('button');
                button.classList.add('horario-btn');
                button.textContent = h.time;
                button.dataset.time = h.time;
                
                // Verifica se há agendamento ativo para este horário
                const temAgendamento = agendamentosNaData.some(a => a.hora === h.time);
                
                if (temAgendamento) {
                    button.classList.add('occupied');
                    button.disabled = true;
                } else if (h.status === 'selected') {
                    button.classList.add('selected');
                }
                
                button.onclick = function() { 
                    if (!button.classList.contains('occupied')) {
                        this.classList.toggle('selected');
                        updateSelectedHorariosCount();
                    }
                };
                
                horariosGrid.appendChild(button);
            });
        }

        function updateSelectedHorariosCount() {
            const count = document.querySelectorAll('#horariosGrid .horario-btn.selected').length;
            const titulo = document.getElementById('horariosSelecionadosTitulo');
            titulo.textContent = `Horários (${count} selecionados)`;
            titulo.style.display = 'block';
        }

        function salvarHorariosManualmente() {
            const data = document.getElementById('dataHorario').value;
            if (!data) {
                alert('Selecione uma data para salvar os horários.');
                return;
            }

            let horariosSalvos = JSON.parse(localStorage.getItem(LS_HORARIOS_KEY)) || {};
            let updatedHorarios = [];
            
            const currentButtons = document.querySelectorAll('#horariosGrid .horario-btn');
            currentButtons.forEach(button => {
                const time = button.dataset.time;
                let status = button.classList.contains('selected') ? 'selected' : 'available';
                
                // Mantém o status 'occupied' se já estiver ocupado
                if (button.classList.contains('occupied')) {
                    status = 'occupied';
                }
                
                updatedHorarios.push({ time, status });
            });

            updatedHorarios.sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time));
            horariosSalvos[data] = updatedHorarios;
            localStorage.setItem(LS_HORARIOS_KEY, JSON.stringify(horariosSalvos));
            alert('Horários salvos com sucesso!');
            carregarHorariosData();
        }

        /* SERVIÇOS */
        async function adicionarOuEditarServico() {
            const index = document.getElementById('servicoIndex').value;
            const nome = document.getElementById('nomeServico').value.trim();
            const descricao = document.getElementById('descricaoServico').value.trim();
            const valor = parseFloat(document.getElementById('valorServico').value);
            const fileInput = document.getElementById('fotoServico');
            const file = fileInput.files[0];

            if (!nome || isNaN(valor)) {
                alert('Por favor, insira um nome e um valor válido.');
                return;
            }

            let servicos = JSON.parse(localStorage.getItem(LS_SERVICOS_KEY)) || [];
            let fotoDataUrl = null;

            if (file) {
                fotoDataUrl = await toBase64(file);
            } else if (index !== '-1') {
                fotoDataUrl = servicos[parseInt(index)].fotoUrl;
            } else {
                fotoDataUrl = 'https://via.placeholder.com/80';
            }
            
            const novoItem = {
                nome,
                fotoUrl: fotoDataUrl,
                descricao,
                valor: valor.toFixed(2)
            };

            if (index === '-1') {
                servicos.push(novoItem);
            } else {
                servicos[parseInt(index)] = novoItem;
            }
            
            localStorage.setItem(LS_SERVICOS_KEY, JSON.stringify(servicos));
            renderizarServicos();
            limparFormularioServico();
        }
        
        function renderizarServicos() {
            const lista = document.getElementById('listaServicos');
            lista.innerHTML = '';
            const servicos = JSON.parse(localStorage.getItem(LS_SERVICOS_KEY)) || [];
            
            if (servicos.length === 0) {
                lista.innerHTML = '<p class="no-data">Nenhum serviço cadastrado.</p>';
                return;
            }

            servicos.forEach((item, index) => {
                const imageUrl = item.fotoUrl && item.fotoUrl !== '' ? item.fotoUrl : 'https://via.placeholder.com/80';

                const li = document.createElement('li');
                li.innerHTML = `
                    <img src="${imageUrl}" alt="${item.nome}"/>
                    <div>
                        <h4>${item.nome} - R$ ${String(item.valor).replace('.', ',')}</h4>
                        <p>${item.descricao || 'Sem descrição.'}</p>
                    </div>
                    <div class="actions">
                        <button class="edit-btn" onclick="editarServico(${index})">Editar</button>
                        <button class="delete-btn" onclick="removerServico(${index})">x</button>
                    </div>
                `;
                lista.appendChild(li);
            });
        }

        function editarServico(index) {
            const servicos = JSON.parse(localStorage.getItem(LS_SERVICOS_KEY)) || [];
            const item = servicos[index];

            document.getElementById('nomeServico').value = item.nome;
            document.getElementById('descricaoServico').value = item.descricao;
            document.getElementById('valorServico').value = parseFloat(item.valor).toFixed(2);
            
            const previewContainer = document.getElementById('previewContainerServico');
            const fotoPreview = document.getElementById('fotoPreviewServico');
            fotoPreview.src = item.fotoUrl;
            previewContainer.style.display = 'block';

            document.getElementById('servicoIndex').value = index;
            document.getElementById('btnAdicionarEditarServico').textContent = 'Salvar Alterações';
        }

        function removerServico(index) {
            if (confirm('Tem certeza que deseja remover este serviço?')) {
                let servicos = JSON.parse(localStorage.getItem(LS_SERVICOS_KEY)) || [];
                servicos.splice(index, 1);
                localStorage.setItem(LS_SERVICOS_KEY, JSON.stringify(servicos));
                renderizarServicos();
                limparFormularioServico();
            }
        }

        function limparFormularioServico() {
            document.getElementById('nomeServico').value = '';
            document.getElementById('fotoServico').value = '';
            document.getElementById('descricaoServico').value = '';
            document.getElementById('valorServico').value = '';
            document.getElementById('servicoIndex').value = '-1';
            
            document.getElementById('previewContainerServico').style.display = 'none';
            document.getElementById('fotoPreviewServico').src = '';
            
            document.getElementById('btnAdicionarEditarServico').textContent = 'Adicionar Serviço';
        }

        /* PRODUTOS */
        async function adicionarOuEditarProduto() {
            const index = document.getElementById('produtoIndex').value;
            const nome = document.getElementById('nomeProduto').value.trim();
            const descricao = document.getElementById('descricaoProduto').value.trim();
            const valor = parseFloat(document.getElementById('valorProduto').value);
            const fileInput = document.getElementById('fotoProduto');
            const file = fileInput.files[0];

            if (!nome || isNaN(valor)) {
                alert('Por favor, insira um nome e um valor válido.');
                return;
            }

            let produtos = JSON.parse(localStorage.getItem(LS_PRODUTOS_KEY)) || [];
            let fotoDataUrl = null;

            if (file) {
                fotoDataUrl = await toBase64(file);
            } else if (index !== '-1') {
                fotoDataUrl = produtos[parseInt(index)].fotoUrl;
            } else {
                fotoDataUrl = 'https://via.placeholder.com/80';
            }
            
            const novoItem = {
                nome,
                fotoUrl: fotoDataUrl,
                descricao,
                valor: valor.toFixed(2)
            };

            if (index === '-1') {
                produtos.push(novoItem);
            } else {
                produtos[parseInt(index)] = novoItem;
            }
            
            localStorage.setItem(LS_PRODUTOS_KEY, JSON.stringify(produtos));
            renderizarProdutos();
            limparFormularioProduto();
        }
        
        function renderizarProdutos() {
            const lista = document.getElementById('listaProdutos');
            lista.innerHTML = '';
            const produtos = JSON.parse(localStorage.getItem(LS_PRODUTOS_KEY)) || [];
            
            if (produtos.length === 0) {
                lista.innerHTML = '<p class="no-data">Nenhum produto cadastrado.</p>';
                return;
            }

            produtos.forEach((item, index) => {
                const imageUrl = item.fotoUrl && item.fotoUrl !== '' ? item.fotoUrl : 'https://via.placeholder.com/80';

                const li = document.createElement('li');
                li.innerHTML = `
                    <img src="${imageUrl}" alt="${item.nome}"/>
                    <div>
                        <h4>${item.nome} - R$ ${String(item.valor).replace('.', ',')}</h4>
                        <p>${item.descricao || 'Sem descrição.'}</p>
                    </div>
                    <div class="actions">
                        <button class="edit-btn" onclick="editarProduto(${index})">Editar</button>
                        <button class="delete-btn" onclick="removerProduto(${index})">x</button>
                    </div>
                `;
                lista.appendChild(li);
            });
        }

        function editarProduto(index) {
            const produtos = JSON.parse(localStorage.getItem(LS_PRODUTOS_KEY)) || [];
            const item = produtos[index];

            document.getElementById('nomeProduto').value = item.nome;
            document.getElementById('descricaoProduto').value = item.descricao;
            document.getElementById('valorProduto').value = parseFloat(item.valor).toFixed(2);
            
            const previewContainer = document.getElementById('previewContainerProduto');
            const fotoPreview = document.getElementById('fotoPreviewProduto');
            fotoPreview.src = item.fotoUrl;
            previewContainer.style.display = 'block';

            document.getElementById('produtoIndex').value = index;
            document.getElementById('btnAdicionarEditarProduto').textContent = 'Salvar Alterações';
        }

        function removerProduto(index) {
            if (confirm('Tem certeza que deseja remover este produto?')) {
                let produtos = JSON.parse(localStorage.getItem(LS_PRODUTOS_KEY)) || [];
                produtos.splice(index, 1);
                localStorage.setItem(LS_PRODUTOS_KEY, JSON.stringify(produtos));
                renderizarProdutos();
                limparFormularioProduto();
            }
        }

        function limparFormularioProduto() {
            document.getElementById('nomeProduto').value = '';
            document.getElementById('fotoProduto').value = '';
            document.getElementById('descricaoProduto').value = '';
            document.getElementById('valorProduto').value = '';
            document.getElementById('produtoIndex').value = '-1';
            
            document.getElementById('previewContainerProduto').style.display = 'none';
            document.getElementById('fotoPreviewProduto').src = '';
            
            document.getElementById('btnAdicionarEditarProduto').textContent = 'Adicionar Produto';
        }

        /* DATAS BLOQUEADAS */
        function bloquearData() {
            const data = document.getElementById('dataBloqueio').value;
            if (!data) {
                alert('Por favor, selecione uma data para bloquear.');
                return;
            }

            let datasBloqueadas = JSON.parse(localStorage.getItem(LS_DATAS_BLOQUEADAS_KEY)) || [];
            if (!datasBloqueadas.includes(data)) {
                datasBloqueadas.push(data);
                localStorage.setItem(LS_DATAS_BLOQUEADAS_KEY, JSON.stringify(datasBloqueadas));
                renderizarDatasBloqueadas();
            } else {
                alert('Esta data já está bloqueada.');
            }
            document.getElementById('dataBloqueio').value = '';
        }

        function renderizarDatasBloqueadas() {
            const listaDatas = document.getElementById('listaDatas');
            listaDatas.innerHTML = '';
            const datasBloqueadas = JSON.parse(localStorage.getItem(LS_DATAS_BLOQUEADAS_KEY)) || [];
            if (datasBloqueadas.length === 0) {
                listaDatas.innerHTML = '<p class="no-data">Nenhuma data bloqueada.</p>';
                return;
            }
            datasBloqueadas.forEach((data, index) => {
                const li = document.createElement('li');
                li.textContent = `🔒 ${data}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'x';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.onclick = () => removerDataBloqueada(index);
                li.appendChild(deleteBtn);

                listaDatas.appendChild(li);
            });
        }

        function removerDataBloqueada(index) {
            let datasBloqueadas = JSON.parse(localStorage.getItem(LS_DATAS_BLOQUEADAS_KEY)) || [];
            datasBloqueadas.splice(index, 1);
            localStorage.setItem(LS_DATAS_BLOQUEADAS_KEY, JSON.stringify(datasBloqueadas));
            renderizarDatasBloqueadas();
        }

        /* LEMBRETES */
        function salvarLembrete() {
            const texto = document.getElementById('lembrete').value.trim();
            if (!texto) {
                alert('O lembrete não pode estar vazio.');
                return;
            }

            let lembretes = JSON.parse(localStorage.getItem(LS_LEMBRETES_KEY)) || [];
            lembretes.push(texto);
            localStorage.setItem(LS_LEMBRETES_KEY, JSON.stringify(lembretes));
            renderizarLembretes();
            document.getElementById('lembrete').value = '';
        }

        function renderizarLembretes() {
            const listaLembretes = document.getElementById('listaLembretes');
            listaLembretes.innerHTML = '';
            const lembretes = JSON.parse(localStorage.getItem(LS_LEMBRETES_KEY)) || [];
            if (lembretes.length === 0) {
                listaLembretes.innerHTML = '<p class="no-data">Nenhum lembrete salvo.</p>';
                return;
            }
            lembretes.forEach((lembrete, index) => {
                const li = document.createElement('li');
                li.textContent = `📌 ${lembrete}`;

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'x';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.onclick = () => removerLembrete(index);
                li.appendChild(deleteBtn);

                listaLembretes.appendChild(li);
            });
        }

        function removerLembrete(index) {
            let lembretes = JSON.parse(localStorage.getItem(LS_LEMBRETES_KEY)) || [];
            lembretes.splice(index, 1);
            localStorage.setItem(LS_LEMBRETES_KEY, JSON.stringify(lembretes));
            renderizarLembretes();
        }

        /* INICIALIZAÇÃO */
        function inicializarAplicacao() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('dataHorario').value = formattedDate;

            // Renderiza as abas inicialmente
            carregarHorariosData();
            renderizarServicos();
            renderizarProdutos();
            renderizarDatasBloqueadas();
            renderizarLembretes();
            renderizarAgendamentos();
            
            // Inicia o intervalo para verificar status dos agendamentos
            window.agendamentoStatusInterval = setInterval(verificarEAtualizarStatusAgendamentos, 60 * 1000);
        }

        /* VERIFICAÇÃO AO CARREGAR A PÁGINA */
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica autenticação
            if (verificarAutenticacao()) {
                document.getElementById('loginModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                inicializarAplicacao();
            } else {
                document.getElementById('loginModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                document.getElementById('adminPassword').focus();
            }
            
            // Permite enviar o formulário com Enter
            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verificarSenha();
                }
            });
        });
    </script>
</body>
</html>
